@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data
@using Microsoft.EntityFrameworkCore

@model IEnumerable<TecBurguer.Models.Hamburguer>

@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager
@inject TecBurguer.Models.DBTecBurguerContext _context

@{
    ViewData["Title"] = "Cardápio Completo";

    var ofertasAtivas = ViewData["OfertasAtivas"] as IEnumerable<TecBurguer.Models.Ofertas>;

    var bebidas = _context.Bebidas.ToList();

    var listaUnificada = new List<dynamic>();

    foreach (var h in Model)
    {
        listaUnificada.Add(new
        {
            Tipo = "Hamburguer",
            Id = h.IdHamburguer,
            Nome = h.Nome,
            Descricao = h.Descricao,
            Preco = h.Preco,
            Imagem = h.Imagem,
            Categoria = h.Categoria,
            ObjetoOriginal = h
        });
    }

    foreach (var b in bebidas)
    {
        listaUnificada.Add(new
        {
            Tipo = "Bebida",
            Id = b.IdBebidas,
            Nome = b.Nome,
            Descricao = "", 
            Preco = b.Preco,
            Imagem = b.Imagem,
            Categoria = "Bebidas",
            ObjetoOriginal = b
        });
    }

    var categorias = listaUnificada.Select(x => x.Categoria).Distinct().Where(c => c != "Todos").OrderBy(c => c).ToList();
    categorias.Insert(0, "Todos");
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ranchers&family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link href="~/css/CardapioModerno.css" rel="stylesheet" />
<div class="menu-container">

    <div class="header-container">

        <h1 class="modern-title">

            CARDÁPIO

        </h1>

    </div>

    <div class="search-wrapper">
        <div class="search-input-group">
            <input type="text" id="searchInput" placeholder="Pesquisar por nome ou ingrediente...">
            <button class="search-btn"><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div class="categories-wrapper">
        @foreach (var cat in categorias)
        {
            var catId = cat.Replace(" ", "_");
            <button class="category-btn @(cat == "Todos" ? "active" : "")"
                    onclick="filtrarCategoria('@catId', this)">
                @cat
            </button>
        }
    </div>

    <div id="menuGrid">
        @foreach (var grupo in listaUnificada.GroupBy(i => i.Categoria).OrderBy(g => g.Key))
        {
            var grupoId = grupo.Key.Replace(" ", "_");

            <div class="category-section" id="section_@grupoId" data-category-id="@grupoId">

                <h2 class="category-title">@grupo.Key</h2>

                <div class="items-grid">
                    @foreach (var item in grupo)
                    {
                        // 1. Lógica de Promoção e Estoque
                        bool temEstoque = true;
                        var promocao = false;
                        decimal precoExibicao = item.Preco ?? 0;
                        TecBurguer.Models.Ofertas ofertaAplicada = null;

                        // -- HAMBURGUER --
                        if (item.Tipo == "Hamburguer")
                        {
                            var h = item.ObjetoOriginal as TecBurguer.Models.Hamburguer;

                            // Estoque: Ingredientes
                            temEstoque = h.HamburguerIgredientes.Any() && h.HamburguerIgredientes.All(i => i.IdIngredienteNavigation!.Quantidade >= i.QuantidadeNecessario);

                            // Oferta
                            if (ofertasAtivas != null)
                            {
                                ofertaAplicada = ofertasAtivas.FirstOrDefault(o => o.idHamburguer == item.Id);
                                if (ofertaAplicada != null)
                                {
                                    promocao = true;
                                    precoExibicao = ofertaAplicada.precoFinal ?? 0;
                                }
                            }
                        }
                        // -- BEBIDA --
                        else if (item.Tipo == "Bebida")
                        {
                            var b = item.ObjetoOriginal as TecBurguer.Models.Bebidas;
                            // Estoque: Quantidade direta
                            temEstoque = (b.Quantidade ?? 0) > 0;
                        }

                        // --- RENDERIZAÇÃO DO CARD ---
                        <div class="BlocoHamburguer" data-name="@item.Nome.ToLower()" data-desc="@item.Descricao.ToLower()">

                            @if (!temEstoque)
                            {
                                <h1 class="ForaDeEstoque">ESGOTADO</h1>
                            }

                            @if (promocao && temEstoque)
                            {
                                <div class="FaixaHamburguer">@(ofertaAplicada?.porcentagem >= 30 ? "MEGA!!" : "OFERTA")</div>
                            }

                            <img src="@item.Imagem"
                                 class="ImagemHamburguer"
                                 style="@(temEstoque ? "" : "filter: grayscale(1); opacity: 0.5;")"
                                 onerror="this.src='/css/Imagens/BurguerLogo.png'">

                            <h3 class="TituloHamburguer">@item.Nome</h3>
                            <p class="DescricaoHamburguer">@item.Descricao</p>

                            <div class="BottomInfoBurguer">

                                @if (promocao && temEstoque)
                                {
                                    <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%;">
                                        <div>
                                            <span style="text-decoration: line-through; color: #666; font-size: 0.9rem;">R$ @item.Preco</span>
                                            <h4 class="PrecoBurguer">R$ @precoExibicao.ToString("N2")</h4>
                                        </div>
                                        <h3 class="PorcentagemOferta">-@ofertaAplicada?.porcentagem%</h3>
                                    </div>
                                }
                                else
                                {
                                    <h4 class="PrecoBurguer">R$ @precoExibicao.ToString("N2")</h4>
                                }

                                <div class="BotoesDoHamburguer">
                                    @if (SignInManager.IsSignedIn(User))
                                    {
                                        if (temEstoque)
                                        {
                                            // Botão Adicionar (Diferente para Burguer/Bebida)
                                            if (item.Tipo == "Hamburguer")
                                            {
                                                <a class="CartBurguer" onclick="adicionarAoCarrinho('@item.Nome', @(promocao? precoExibicao : item.Preco), '@item.Id', '@UserManager.GetUserName(User)')">
                                                    <i class="fas fa-shopping-cart"></i>
                                                </a>
                                            }
                                            else
                                            {
                                                <a class="CartBurguer" onclick="adicionarBebidaAoCarrinho('@item.Nome', @item.Preco, '@item.Id', '@UserManager.GetUserName(User)')">
                                                    <i class="fas fa-shopping-cart"></i>
                                                </a>
                                            }
                                        }
                                        else
                                        {
                                            <a class="CartBurguer" style="opacity: 0.5; cursor: not-allowed;">
                                                <i class="fas fa-ban"></i>
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <a class="CartBurguer" onclick="mostrarBotaoLogin()">
                                            <i class="fas fa-shopping-cart"></i>
                                        </a>
                                    }

                                    @if (item.Tipo == "Hamburguer")
                                    {
                                        <a class="SaibaMaisHamburguer"
                                           asp-controller="Hamburgueres"
                                           asp-action="Details"
                                           asp-route-id="@item.Id">
                                            VER MAIS
                                        </a>
                                    }
                                    else
                                    {
                                        <a class="SaibaMaisHamburguer" style="opacity:0.5; cursor:default;">BEBIDA</a>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<div id="FacaLogin">
    <img src="~/css/Imagens/BurguerLogo.png" alt="Logo">
    <div style="flex-grow: 1;">
        @if (SignInManager.IsSignedIn(User))
        {
            <h3>Adicionado!</h3>
            <p>Item adicionado ao carrinho!</p>
            <div style="margin-top: 10px;">
                <a class="BotaoLogin" asp-area="" asp-controller="Home" asp-action="Cart">Ir para Carrinho</a>
            </div>
        }
        else
        {
            <h3>Psiu! 🍔</h3>
            <p>Faça login para continuar.</p>
            <div style="margin-top: 10px; display: flex;">
                <a class="BotaoCriarConta" asp-area="Identity" asp-page="/Account/Register">Criar conta</a>
                <a class="BotaoLogin" asp-area="Identity" asp-page="/Account/Login">Login</a>
            </div>
        }
    </div>
    <button onclick="fecharPopup()" style="background: transparent; border: none; font-size: 1.2rem; cursor: pointer; color: #333;">&times;</button>
</div>

<div id="LoadingOverlay">
    <div class="loading-content">
        <div class="reactor-loader">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="icon-center">
                <i class="fas fa-hamburger icon-burger"></i>
                <i class="fas fa-shopping-cart icon-cart"></i>
            </div>
        </div>
        <h3 class="loading-text">PREPARANDO PEDIDO...</h3>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    function filtrarCategoria(categoriaId, btnElement) {
        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        document.getElementById('searchInput').value = "";

        const todasSecoes = document.querySelectorAll('.category-section');
        const todosCards = document.querySelectorAll('.BlocoHamburguer');

        if (categoriaId === 'Todos') {
            todasSecoes.forEach(sec => sec.style.display = 'block');
            todosCards.forEach(card => card.style.display = 'flex');
        } else {
            todasSecoes.forEach(sec => sec.style.display = 'none');
            const secaoAlvo = document.getElementById('section_' + categoriaId);
            if (secaoAlvo) {
                secaoAlvo.style.display = 'block';
                secaoAlvo.querySelectorAll('.BlocoHamburguer').forEach(card => card.style.display = 'flex');
            }
        }
    }

    document.getElementById('searchInput').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const todasSecoes = document.querySelectorAll('.category-section');

        if (termo === '') {
            const btnAtivo = document.querySelector('.category-btn.active');
            if(btnAtivo) btnAtivo.click();
            return;
        }

        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));

        todasSecoes.forEach(secao => {
            const cards = secao.querySelectorAll('.BlocoHamburguer');
            let encontrouNaSecao = false;

            cards.forEach(card => {
                const nome = card.dataset.name;
                const desc = card.dataset.desc;

                if (nome.includes(termo) || desc.includes(termo)) {
                    card.style.display = 'flex';
                    encontrouNaSecao = true;
                } else {
                    card.style.display = 'none';
                }
            });

            secao.style.display = encontrouNaSecao ? 'block' : 'none';
        });
    });
</script>