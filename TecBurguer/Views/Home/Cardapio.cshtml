@model IEnumerable<TecBurguer.Models.Hamburguer>
@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data
@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager

@{
    ViewData["Title"] = "Cardápio Completo";

    // Categorias e Ofertas
    var categorias = Model.Select(h => h.Categoria).Distinct().Where(c => c != "Todos").OrderBy(c => c).ToList();
    categorias.Insert(0, "Todos");

    var ofertasAtivas = ViewData["OfertasAtivas"] as IEnumerable<TecBurguer.Models.Ofertas>;
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ranchers&family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link href="~/css/CardapioModerno.css" rel="stylesheet" />

<div class="menu-container">

    <div class="header-container">
        <h1 class="modern-title">
            CARDÁPIO
        </h1>
    </div>

    <div class="search-wrapper">
        <div class="search-input-group">
            <input type="text" id="searchInput" placeholder="Pesquisar por nome ou ingrediente...">
            <button class="search-btn"><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div class="categories-wrapper">
        @foreach (var cat in categorias)
        {
            var catId = cat.Replace(" ", "_");
            <button class="category-btn @(cat == "Todos" ? "active" : "")"
                    onclick="filtrarCategoria('@catId', this)">
                @cat
            </button>
        }
    </div>

    <div id="menuGrid">
        @foreach (var grupo in Model.GroupBy(h => h.Categoria))
        {
            var grupoId = grupo.Key.Replace(" ", "_");

            <div class="category-section" id="section_@grupoId" data-category-id="@grupoId">

                <h2 class="category-title">@grupo.Key</h2>

                <div class="items-grid">
                    @foreach (var item in grupo)
                    {
                        Console.WriteLine(item.Nome);
                        Console.WriteLine(item.HamburguerIgredientes.Any());
                        Console.WriteLine(item.HamburguerIgredientes.All(i => i.IdIngredienteNavigation!.Quantidade >= i.QuantidadeNecessario));
                        bool temEstoque = item.HamburguerIgredientes.Any() && item.HamburguerIgredientes.All(i => i.IdIngredienteNavigation!.Quantidade >= i.QuantidadeNecessario);

                        TecBurguer.Models.Ofertas ofertaAtiva = null;

                        if (ofertasAtivas != null)
                        {
                            ofertaAtiva = ofertasAtivas.FirstOrDefault(o => o.idHamburguer == item.IdHamburguer);
                        }
                        bool temOferta = ofertaAtiva != null;

                        // --- CARD (Cópia Exata da Home com Lógica) ---
                        <div class="BlocoHamburguer" data-name="@item.Nome.ToUpper()" data-desc="@item.Descricao.ToLower()">

                            @if (!temEstoque)
                            {
                                <h1 class="ForaDeEstoque">FORA DE ESTOQUE</h1>
                            }

                            @if (temOferta && temEstoque)
                            {
                                <div class="FaixaHamburguer">@(ofertaAtiva?.porcentagem >= 30 ? "MEGA!!" : "OFERTA")</div>
                            }

                            <img src="@Html.DisplayFor(modelItem => item.Imagem)"
                                 class="ImagemHamburguer"
                                 style="@(temEstoque ? "" : "filter: grayscale(1); opacity: 0.5;")"
                                 onerror="this.src='/css/Imagens/BurguerLogo.png'">

                            <h3 class="TituloHamburguer">@item.Nome</h3>
                            <p class="DescricaoHamburguer">@item.Descricao</p>

                            <div class="BottomInfoBurguer">

                                @if (temOferta && temEstoque)
                                {
                                    <div style="display: flex; justify-content: space-between; align-items: flex-end; width: 100%;">
                                        <div>
                                            <span style="text-decoration: line-through; color: #666; font-size: 0.9rem;">R$ @item.Preco</span>
                                            <h4 class="PrecoBurguer">R$ @ofertaAtiva?.precoFinal</h4>
                                        </div>
                                        <h3 class="PorcentagemOferta">-@ofertaAtiva?.porcentagem%</h3>
                                    </div>
                                }
                                else
                                {
                                    <h4 class="PrecoBurguer">R$ @item.Preco</h4>
                                }

                                <div class="BotoesDoHamburguer">
                                    @if (SignInManager.IsSignedIn(User))
                                    {
                                        if (temEstoque)
                                        {
                                            <a class="CartBurguer" onclick="adicionarAoCarrinho('@item.Nome', @(temOferta? ofertaAtiva.precoFinal: item.Preco), '@item.IdHamburguer', '@UserManager.GetUserName(User)')">
                                                <i class="fas fa-shopping-cart"></i>
                                            </a>
                                        }
                                        else
                                        {
                                            <a class="CartBurguer" style="opacity: 0.5; cursor: not-allowed;">
                                                <i class="fas fa-ban"></i>
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <a class="CartBurguer" onclick="mostrarBotaoLogin()">
                                            <i class="fas fa-shopping-cart"></i>
                                        </a>
                                    }

                                    <a class="SaibaMaisHamburguer"
                                       asp-controller="Hamburgueres"
                                       asp-action="Details"
                                       asp-route-id="@item.IdHamburguer">
                                        VER MAIS
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<script>
    function filtrarCategoria(categoriaId, btnElement) {
        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        document.getElementById('searchInput').value = "";

        const todasSecoes = document.querySelectorAll('.category-section');
        const todosCards = document.querySelectorAll('.BlocoHamburguer'); // Atualizado classe

        if (categoriaId === 'Todos') {
            todasSecoes.forEach(sec => sec.style.display = 'block');
            todosCards.forEach(card => card.style.display = 'flex');
        } else {
            todasSecoes.forEach(sec => sec.style.display = 'none');
            const secaoAlvo = document.getElementById('section_' + categoriaId);
            if (secaoAlvo) {
                secaoAlvo.style.display = 'block';
                secaoAlvo.querySelectorAll('.BlocoHamburguer').forEach(card => card.style.display = 'flex');
            }
        }
    }

    document.getElementById('searchInput').addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        const todasSecoes = document.querySelectorAll('.category-section');

        if (termo === '') {
            const btnAtivo = document.querySelector('.category-btn.active');
            if(btnAtivo) btnAtivo.click();
            return;
        }

        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));

        todasSecoes.forEach(secao => {
            const cards = secao.querySelectorAll('.BlocoHamburguer');
            let encontrouNaSecao = false;

            cards.forEach(card => {
                const nome = card.dataset.name;
                const desc = card.dataset.desc;

                if (nome.includes(termo) || desc.includes(termo)) {
                    card.style.display = 'flex';
                    encontrouNaSecao = true;
                } else {
                    card.style.display = 'none';
                }
            });

            secao.style.display = encontrouNaSecao ? 'block' : 'none';
        });
    });
</script>