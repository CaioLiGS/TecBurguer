@model IEnumerable<TecBurguer.Models.Hamburguer>
@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data
@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager

<link rel="stylesheet" href="~/css/CardapioOriginal.css" asp-append-version="true">

<div class="BarraPesquisa">
    <input type="text" id="pesquisa" placeholder="Pesquisar hambúrguer...">
</div>

@{
    var categorias = Model.Select(h => h.Categoria)
                          .Distinct()
                          .Where(c => c != "Todos")
                          .ToList();
    categorias.Insert(0, "Todos");
}

<div class="MenuCategoria">
    @foreach (var categoria in categorias)
    {
        <a href="#" 
           class="LinkCategoria" 
           data-categoria="@categoria.Replace(" ", "-")"
           title="Filtrar por @categoria">
            @categoria
        </a>
    }
</div>

@foreach (var grupo in Model.GroupBy(h => h.Categoria))
{
    <h2 class="TituloCategoria" id="Categoria_@grupo.Key.Replace(" ", "-")">@grupo.Key</h2>

    <div class="ContainerCategoria" data-categoria-container="@grupo.Key.Replace(" ", "-")">
        @foreach (var item in grupo)
        {
            <div class="BlocoHamburguer" data-categoria-item="@item.Categoria.Replace(" ", "-")">
                <img src="@Html.DisplayFor(modelItem => item.Imagem)"
                     class="ImagemHamburguer"
                     alt="@item.Nome"
                     onerror="this.src='/css/Imagens/BurguerLogo.png'">

                <div class="BottomInfoBurguer">
                    <h3 class="TituloHamburguer" id="NomeBurguer_@item.IdHamburguer">
                        @Html.DisplayFor(modelItem => item.Nome)
                    </h3>

                    <p class="DescricaoHamburguer">
                        @Html.DisplayFor(modelItem => item.Descricao)
                    </p>

                    <h4 class="PrecoBurguer" id="PrecoBurguer_@item.IdHamburguer">
                        R$ @string.Format("{0:0.00}", item.Preco)
                    </h4>

                    <div class="BotoesDoHamburguer">
                        @if (SignInManager.IsSignedIn(User))
                        {
                            <button class="CartBurguer"
                                    onclick="adicionarAoCarrinho('@item.Nome', @item.Preco, @item.IdHamburguer, '@User.Identity.Name')"
                                    title="Adicionar ao carrinho"
                                    type="button">
                                <img src="~/css/Imagens/IconCart.png" alt="Carrinho">
                            </button>
                        }
                        else
                        {
                            <button class="CartBurguer" 
                                    onclick="mostrarBotaoLogin()" 
                                    title="Faça login para adicionar" 
                                    type="button">
                                <img src="~/css/Imagens/IconCart.png" alt="Carrinho">
                            </button>
                        }

                        <a class="SaibaMaisHamburguer"
                           asp-controller="Hamburgueres"
                           asp-action="Details"
                           asp-route-id="@item.IdHamburguer">
                            Saiba Mais
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
}

<script>
    document.getElementById('pesquisa').addEventListener('input', function () {
        const termo = this.value.toLowerCase();
        const hamburgueres = document.querySelectorAll('.BlocoHamburguer');
        hamburgueres.forEach(bloco => {
            const nome = bloco.querySelector('.TituloHamburguer').textContent.toLowerCase();
            bloco.style.display = nome.includes(termo) ? 'block' : 'none';
        });
        document.querySelectorAll('.TituloCategoria').forEach(titulo => {
            const container = document.querySelector(`[data-categoria-container='${titulo.id.replace('Categoria_', '')}']`);
            if (container) {
                const blocosVisiveis = container.querySelectorAll('.BlocoHamburguer:not([style*="display: none"])');
                titulo.style.display = blocosVisiveis.length > 0 ? 'block' : 'none';
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const linksCategoria = document.querySelectorAll('.LinkCategoria');
        const todosOsBlocos = document.querySelectorAll('.BlocoHamburguer');
        const todosOsTitulos = document.querySelectorAll('.TituloCategoria');

        function filtrarPorCategoria(categoriaAlvo) {
            todosOsTitulos.forEach(titulo => titulo.style.display = 'none');
            todosOsBlocos.forEach(bloco => bloco.style.display = 'none');
            linksCategoria.forEach(link => {
                if (link.dataset.categoria === categoriaAlvo) {
                    link.classList.add('ativo');
                } else {
                    link.classList.remove('ativo');
                }
            });

            if (categoriaAlvo === 'Todos') {
                todosOsTitulos.forEach(titulo => titulo.style.display = 'block');
                todosOsBlocos.forEach(bloco => bloco.style.display = 'block');
            } else {
                document.getElementById('pesquisa').value = '';
                const tituloAlvo = document.getElementById(`Categoria_${categoriaAlvo}`);
                if (tituloAlvo) {
                    tituloAlvo.style.display = 'block';
                }

                document.querySelectorAll(`[data-categoria-item='${categoriaAlvo}']`).forEach(bloco => {
                    bloco.style.display = 'block';
                });
            }
            
            const primeiroTituloVisivel = document.querySelector('.TituloCategoria[style*="block"]');
            if (primeiroTituloVisivel) {
                primeiroTituloVisivel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        linksCategoria.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const categoria = this.dataset.categoria;
                filtrarPorCategoria(categoria);
            });
        });

        filtrarPorCategoria('Todos');
    });
</script>