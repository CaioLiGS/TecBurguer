@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data

@model IEnumerable<TecBurguer.Models.Hamburguer>

@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager

@{
    ViewData["Title"] = "Home Page";

    var ofertasAtivas = ViewData["OfertasAtivas"] as IEnumerable<TecBurguer.Models.Ofertas>;
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ranchers&display=swap" rel="stylesheet">


<div class="BannerContent" id="BannerContent">
    <div class="Spotlight"></div>
    <div id="particles-container"></div> <div class="conteudoBannerContent">
        <div class="textos">
            <h1 class="title-tec">TEC</h1>
            <h1 class="title-burger">BURGER</h1>
            <p class="subtitle-banner">
                O verdadeiro sabor artesanal, feito com paixão e tecnologia. <br>
                Experimente o futuro hoje.
            </p>

            <a href="#Cardapio" class="btn-banner">
                FAZER PEDIDO <i class="fas fa-fire-alt" style="margin-left: 8px;"></i>
            </a>
        </div>

        <div class="bannerWrapper">
            <img class="BurgerImageBanner active" id="bannerPrincipal" src="/css/Imagens/BurguerLogo.png" alt="Hamburguer">
        </div>
    </div>

    <div class="BannerOverlay">
        <a asp-controller="Home"
           asp-action="Index"
           asp-fragment="OfertasDiarias"
           class="ScrollDown"
           style="cursor: pointer; text-decoration: none; pointer-events: auto; z-index: 1000;">
            Ver Promoções
            <i class="fas fa-chevron-down" style="display:block; margin-top: 5px;"></i>
        </a>
    </div>
</div>

<script>
    // 1. LÓGICA DO SLIDER DE IMAGENS (Não alterada)
    var imagens = [
        @foreach (var item in Model)
        {
                     @: "@Html.DisplayFor(modelItem => item.Imagem)",
        }
    ];

    // Fallback caso não tenha imagens do banco
    if(imagens.length === 0) {
        imagens.push("/css/Imagens/BurguerLogo.png");
    }

    var index = 0;
    var bannerWrapper = document.querySelector(".bannerWrapper");

    function trocarImagemBanner() {
        if (!imagens.length || !bannerWrapper) return;

        var atual = document.querySelector(".BurgerImageBanner.active");

        // Criar próxima imagem
        var proxima = document.createElement("img");
        proxima.src = imagens[index];
        proxima.className = "BurgerImageBanner"; // Começa invisível e deslocada
        bannerWrapper.appendChild(proxima);

        // Force reflow (para o navegador processar a animação)
        void proxima.offsetWidth;

        proxima.classList.add("active"); // Ativa animação de entrada

        if (atual) {
            atual.classList.remove("active");
            atual.classList.add("exit"); // Ativa animação de saída

            // Remove do DOM após a animação terminar
            setTimeout(() => {
                if(atual.parentNode === bannerWrapper) bannerWrapper.removeChild(atual);
            }, 600); // 600ms corresponde à transition CSS
        }

        index = (index + 1) % imagens.length;
    }

    // Troca a cada 4.5 segundos para dar tempo de ler o texto
    setInterval(trocarImagemBanner, 4500);
    // Inicia a rotação logo após a primeira imagem estática
    setTimeout(trocarImagemBanner, 4500);


    // 2. LÓGICA DAS PARTÍCULAS (EFEITO DE BRASAS) (Não alterada)
    function createEmbers() {
        const container = document.getElementById('BannerContent');
        const particleCount = 30; // Quantidade de brasas

        for (let i = 0; i < particleCount; i++) {
            setTimeout(() => {
                spawnEmber(container);
            }, i * 300); // Cria uma brasa a cada 300ms aleatoriamente
        }
    }

    function spawnEmber(container) {
        const ember = document.createElement('div');
        ember.classList.add('ember');

        // Tamanho aleatório
        const size = Math.random() * 6 + 2 + 'px';
        ember.style.width = size;
        ember.style.height = size;

        // Posição horizontal aleatória
        ember.style.left = Math.random() * 100 + '%';

        // Duração da animação aleatória
        const duration = Math.random() * 3 + 2 + 's';
        ember.style.animationDuration = duration;

        container.appendChild(ember);

        // Remove a partícula depois que ela subir
        setTimeout(() => {
            ember.remove();
            spawnEmber(container); // Cria uma nova para substituir (loop infinito)
        }, parseFloat(duration) * 1000);
    }

    // Inicia as brasas
    createEmbers();
</script>

<div class="Content1" id="OfertasDiarias">
    <h2 class="section-title reveal">OFERTAS EM CHAMAS 🔥</h2>

    <div class="cards-container reveal">
        @if (ofertasAtivas != null && ofertasAtivas.Any())
        {
            @foreach (var oferta in ofertasAtivas)
            {
                if (oferta.idHamburguerNavigation == null) { continue; }
                var item = oferta.idHamburguerNavigation;

                <div class="BlocoHamburguer">
                    <div class="FaixaHamburguer">@(oferta.porcentagem >= 30 ? "MEGA!!" : "OFERTA")</div>

                    <img src="@Html.DisplayFor(modelItem => item.Imagem)" class="ImagemHamburguer" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                    <h3 class="TituloHamburguer">@item.Nome</h3>
                    <p class="DescricaoHamburguer">@item.Descricao</p>

                    <div class="BottomInfoBurguer">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div>
                                <span style="text-decoration: line-through; color: #666; font-size: 0.9rem;">R$ @item.Preco</span>
                                <h4 class="PrecoBurguer">R$ @oferta.precoFinal</h4>
                            </div>
                            <h3 class="PorcentagemOferta">-@oferta.porcentagem%</h3>
                        </div>

                        <div class="BotoesDoHamburguer">
                            @if (SignInManager.IsSignedIn(User))
                            {
                                <a class="CartBurguer" onclick="adicionarAoCarrinho('@item.Nome', @item.Preco, '@item.IdHamburguer', '@UserManager.GetUserName(User)')">
                                    <i class="fas fa-shopping-cart"></i>
                                </a>
                            }
                            else
                            {
                                <a class="CartBurguer" onclick="mostrarBotaoLogin()">
                                    <i class="fas fa-shopping-cart"></i>
                                </a>
                            }
                            <a class="SaibaMaisHamburguer" asp-controller="Hamburgueres" asp-action="Details" asp-route-id="@item.IdHamburguer">DETALHES</a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div style="width: 100%; text-align: center; padding: 50px; color: #777;">
                <h3>Nenhuma oferta pegando fogo hoje.</h3>
            </div>
        }
    </div>
</div>

<div class="Content2 reveal" id="RecomendacoesDoChefe">
    <h1 class="section-title" style="color: white; text-shadow: 0 0 20px var(--primary);">RECOMENDAÇÕES DO CHEFE</h1>

    <div class="ConteudoRecomendacoesDoChefe">
        <div class="carrossel-wrapper" id="RecomendacoesCarrossel">
            @* Adicionei um ID para facilitar no JS *@
            @foreach (var item in Model)
            {
                @if (item.Categoria == "Recomendação do chefe")
                {
                    <div class="item-recomendacao">
                        <img src="@item.Imagem" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                        <div class="info">
                            <div>
                                <h2 class="TituloRDC">@item.Nome</h2>
                                <p style="color: var(--text-light); opacity: 0.9; margin-bottom: 15px;">@item.Descricao</p>

                                <h5 style="font-weight: bold; font-size: 1.2rem; color: var(--accent); text-align: left; margin-top: 10px;">Ingredientes:</h5>
                                <ul class="lista-ingredientes">
                                    @foreach (var ingrediente in item.HamburguerIgredientes)
                                    {
                                        @if (ingrediente.IdIngredienteNavigation != null)
                                        {
                                            <li>@ingrediente.IdIngredienteNavigation.Nome</li>
                                        }
                                    }
                                </ul>
                            </div>

                            <div class="BotoesRDC">
                                @if (SignInManager.IsSignedIn(User))
                                {
                                    <a class="CartBurguer"
                                                           onclick="adicionarAoCarrinho('@item.Nome', @item.Preco, '@item.IdHamburguer', '@UserManager.GetUserName(User)')"
                                                           title="Adicionar ao carrinho"
                                                           style="width: 50%;">
                                        <img class="cart-icon" src="~/css/Imagens/IconCart.png">
                                        <span class="cart-text">Adicionar ao carrinho</span>
                                    </a>
                                }
                                else
                                {
                                    <a class="CartBurguer"
                                                           onclick="mostrarBotaoLogin()"
                                                           title="Adicionar ao carrinho"
                                                           style="width: 50%;">
                                        <img class="cart-icon" src="~/css/Imagens/IconCart.png">
                                        <span class="cart-text">Adicionar ao carrinho</span>
                                    </a>
                                }

                                <a class="SaibaMaisHamburguer" asp-controller="Hamburgueres"
                                                     asp-action="Details" asp-route-id="@item.IdHamburguer"
                                                     style="width: 50%; background-color: var(--dark); border-radius: 20px;">
                                    Saiba Mais
                                </a>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>

        <button class="prev-slide" onclick="prevSlide()"><i class="fas fa-chevron-left"></i></button>
        <button class="next-slide" onclick="nextSlide()"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<div class="Content1" id="Cardapio" style="height: auto; padding-bottom: 50px;">
    <h2 class="section-title reveal">CARDÁPIO COMPLETO</h2>

    @* NOVO CONTAINER PRINCIPAL DO CARROSSEL DO CARDÁPIO COMPLETO *@
    <div class="CardapioCarrosselContainer reveal">

        <button class="prev-slide" onclick="prevSlideCardapio()"><i class="fas fa-chevron-left"></i></button>

        <div class="carrossel-wrapper" id="CardapioCarrossel">
            @* NOVO ID para JS *@
            @foreach (var item in Model)
            {
                var promocao = false;
                @if (ofertasAtivas != null && ofertasAtivas.Any())
                {
                    foreach (var oferta in ofertasAtivas)
                    {
                        if (oferta.idHamburguerNavigation != null && oferta.idHamburguerNavigation.IdHamburguer == item.IdHamburguer)
                        {
                            promocao = true;
                            break;
                        }
                    }
                }

                @if (!promocao)
                {
                    <div class="BlocoHamburguer" style="margin-bottom: 30px;">
                        <img src="@Html.DisplayFor(modelItem => item.Imagem)" class="ImagemHamburguer" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                        <h3 class="TituloHamburguer">@item.Nome</h3>
                        <p class="DescricaoHamburguer">@item.Descricao</p>

                        <div class="BottomInfoBurguer">
                            <h4 class="PrecoBurguer">R$ @item.Preco</h4>
                            <div class="BotoesDoHamburguer">
                                @if (SignInManager.IsSignedIn(User))
                                {
                                    <a class="CartBurguer" onclick="adicionarAoCarrinho('@item.Nome', @item.Preco, '@item.IdHamburguer', '@UserManager.GetUserName(User)')">
                                        <i class="fas fa-shopping-cart"></i>
                                    </a>
                                }
                                else
                                {
                                    <a class="CartBurguer" onclick="mostrarBotaoLogin()">
                                        <i class="fas fa-shopping-cart"></i>
                                    </a>
                                }
                                <a class="SaibaMaisHamburguer" asp-controller="Hamburgueres" asp-action="Details" asp-route-id="@item.IdHamburguer">VER MAIS</a>
                            </div>
                        </div>
                    </div>
                }
            }
        </div> @* Fim do carrossel-wrapper com ID CardapioCarrossel *@

        <button class="next-slide" onclick="nextSlideCardapio()"><i class="fas fa-chevron-right"></i></button>

    </div> @* Fim do CardapioCarrosselContainer *@

    <div style="text-align: center; padding-bottom: 30px;">
        <a asp-controller="Home"
               asp-action="Cardapio"
               style="color: var(--primary); text-decoration: underline; cursor: pointer;">
            Acesse nosso cardapio completo
        </a>
    </div>
</div>

<div id="FacaLogin">
    @* Código do popup de login (Não alterado) *@
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="~/js/site.js"></script>

<script>
    // Se a barra de rolagem horizontal estiver na página inteira, adicione o CSS abaixo em sua folha de estilos:
    // body { overflow-x: hidden; }

    // Se estiver na seção de conteúdo, adicione em seu CSS:
    // .Content2, .Content1 { overflow-x: hidden; }

    // E certifique-se que o carrossel tenha rolagem interna:
    // .carrossel-wrapper { overflow-x: auto; white-space: nowrap; }

    // --------------------------------------------------------------------------------
    // NOVAS FUNÇÕES JAVASCRIPT PARA CONTROLE DO CARROSSEL
    // --------------------------------------------------------------------------------

    // Elementos do carrossel:
    const recomendacoesCarrossel = document.getElementById('RecomendacoesCarrossel');
    const cardapioCarrossel = document.getElementById('CardapioCarrossel');

    // Valor de rolagem: Ajuste este valor (em pixels) para rolar por 1 item
    const scrollAmount = 350;

    // Carrossel: RECOMENDAÇÕES DO CHEFE (usa prevSlide/nextSlide)
    function prevSlide() {
        if (recomendacoesCarrossel) {
            recomendacoesCarrossel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        }
    }

    function nextSlide() {
        if (recomendacoesCarrossel) {
            recomendacoesCarrossel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }

    // Carrossel: CARDÁPIO COMPLETO (usa prevSlideCardapio/nextSlideCardapio)
    function prevSlideCardapio() {
        if (cardapioCarrossel) {
            cardapioCarrossel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        }
    }

    function nextSlideCardapio() {
        if (cardapioCarrossel) {
            cardapioCarrossel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }

    // --------------------------------------------------------------------------------
    // OUTRAS FUNÇÕES (Não alteradas)
    // --------------------------------------------------------------------------------

    window.addEventListener('scroll', reveal);
    function reveal() {
        var reveals = document.querySelectorAll('.reveal');
        for (var i = 0; i < reveals.length; i++) {
            var windowheight = window.innerHeight;
            var revealtop = reveals[i].getBoundingClientRect().top;
            var revealpoint = 150;
            if (revealtop < windowheight - revealpoint) {
                reveals[i].classList.add('active');
            }
        }
    }
    reveal();

    document.querySelectorAll('.BlocoHamburguer').forEach(card => {
        card.addEventListener('mousemove', e => {
            let rect = card.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            let centerX = rect.width / 2;
            let centerY = rect.height / 2;

            let rotateX = ((y - centerY) / centerY) * -10;
            let rotateY = ((x - centerX) / centerX) * 10;

            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
        });

        card.addEventListener('mouseleave', () => {
            card.style.transform = `perspective(1000px) rotateX(0) rotateY(0) scale(1)`;
        });
    });
</script>