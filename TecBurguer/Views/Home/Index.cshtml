@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data

@model IEnumerable<TecBurguer.Models.Hamburguer>

@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager
@inject TecBurguer.Models.DBTecBurguerContext _context

@{
    ViewData["Title"] = "Tec Burguer";

    var ofertasAtivas = ViewData["OfertasAtivas"] as IEnumerable<TecBurguer.Models.Ofertas>;

    var bebidas = _context.Bebidas.ToList();

    var listaMista = new List<dynamic>();

    foreach (var h in Model)
    {
        listaMista.Add(new
        {
            Tipo = "Hamburguer",
            Id = h.IdHamburguer,
            Nome = h.Nome,
            Descricao = h.Descricao,
            Preco = h.Preco,
            Imagem = h.Imagem,
            ObjetoOriginal = h 
        });
    }
    foreach (var b in bebidas)
    {
        listaMista.Add(new
        {
            Tipo = "Bebida",
            Id = b.IdBebidas,
            Nome = b.Nome,
            Preco = b.Preco,
            Imagem = b.Imagem,
            Descricao = "",
            ObjetoOriginal = b
        });
    }

    var cardapioAleatorio = listaMista.OrderBy(x => Guid.NewGuid()).Take(20).ToList();
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ranchers&display=swap" rel="stylesheet">

<div class="BannerContent" id="BannerContent">
    <div class="Spotlight"></div>
    <div id="particles-container"></div> <div class="conteudoBannerContent">
        <div class="textos">
            <h1 class="title-tec">TEC</h1>
            <h1 class="title-burger">BURGER</h1>
            <p class="subtitle-banner">
                O verdadeiro sabor artesanal, feito com paixão e tecnologia. <br>
                Experimente o futuro hoje.
            </p>

            <a href="#Cardapio" class="btn-banner">
                FAZER PEDIDO <i class="fas fa-fire-alt" style="margin-left: 8px;"></i>
            </a>
        </div>

        <div class="bannerWrapper">
            <img class="BurgerImageBanner active" id="bannerPrincipal" src="/css/Imagens/BurguerLogo.png" alt="Hamburguer">
        </div>
    </div>

    <div class="BannerOverlay">
        <a href="#OfertasDiarias" class="ScrollDown" style="cursor: pointer">
            Ver Promoções
            <i class="fas fa-chevron-down" style="display:block; margin-top: 5px;"></i>
        </a>
    </div>
</div>

<script>
    var imagens = [
        @foreach (var item in Model)
        {
                         @: "@Html.DisplayFor(modelItem => item.Imagem)",
        }
    ];

    if(imagens.length === 0) {
        imagens.push("/css/Imagens/BurguerLogo.png");
    }

    var index = 0;
    var bannerWrapper = document.querySelector(".bannerWrapper");

    function trocarImagemBanner() {
        if (!imagens.length || !bannerWrapper) return;

        var atual = document.querySelector(".BurgerImageBanner.active");

        var proxima = document.createElement("img");
        proxima.src = imagens[index];
        proxima.className = "BurgerImageBanner";
        bannerWrapper.appendChild(proxima);

        void proxima.offsetWidth;

        proxima.classList.add("active"); 

        if (atual) {
            atual.classList.remove("active");
            atual.classList.add("exit"); 

            setTimeout(() => {
                if(atual.parentNode === bannerWrapper) bannerWrapper.removeChild(atual);
            }, 600); // 600ms corresponde à transition CSS
        }

        index = (index + 1) % imagens.length;
    }

    // Troca a cada 4.5 segundos para dar tempo de ler o texto
    setInterval(trocarImagemBanner, 4500);
    // Inicia a rotação logo após a primeira imagem estática
    setTimeout(trocarImagemBanner, 4500);


    // 2. LÓGICA DAS PARTÍCULAS (EFEITO DE BRASAS)
    function createEmbers() {
        const container = document.getElementById('BannerContent');
        const particleCount = 30; // Quantidade de brasas

        for (let i = 0; i < particleCount; i++) {
            setTimeout(() => {
                spawnEmber(container);
            }, i * 300); // Cria uma brasa a cada 300ms aleatoriamente
        }
    }

    function spawnEmber(container) {
        const ember = document.createElement('div');
        ember.classList.add('ember');

        const size = Math.random() * 6 + 2 + 'px';
        ember.style.width = size;
        ember.style.height = size;

        ember.style.left = Math.random() * 100 + '%';

        const duration = Math.random() * 3 + 2 + 's';
        ember.style.animationDuration = duration;

        container.appendChild(ember);

        setTimeout(() => {
            ember.remove();
            spawnEmber(container); 
        }, parseFloat(duration) * 1000);
    }

    createEmbers();
</script>

<div class="Content1" id="OfertasDiarias">

    <div class="MarqueeContainer reveal">
        <div class="MarqueeTrack">
            <span class="MarqueeItem">OFERTAS EM CHAMAS <i class="fas fa-fire"></i></span>
            <span class="MarqueeItem">APROVEITE AGORA <i class="fas fa-stopwatch"></i></span>
            <span class="MarqueeItem">SABOR EXPLOSIVO <i class="fas fa-bomb"></i></span>

            <span class="MarqueeItem">OFERTAS EM CHAMAS <i class="fas fa-fire"></i></span>
            <span class="MarqueeItem">APROVEITE AGORA <i class="fas fa-stopwatch"></i></span>
            <span class="MarqueeItem">SABOR EXPLOSIVO <i class="fas fa-bomb"></i></span>
            <span class="MarqueeItem">OFERTAS EM CHAMAS <i class="fas fa-fire"></i></span>
            <span class="MarqueeItem">APROVEITE AGORA <i class="fas fa-stopwatch"></i></span>
            <span class="MarqueeItem">SABOR EXPLOSIVO <i class="fas fa-bomb"></i></span>
        </div>
    </div>

    <div class="OfertasCarrosselContainer reveal" style="height: 80%;">

        <button class="prev-slide" onclick="prevSlideOfertas()"><i class="fas fa-chevron-left"></i></button>

        <div class="carrossel-ofertas" id="OfertasCarrossel">
            @if (ofertasAtivas != null && ofertasAtivas.Any())
            {
                @foreach (var oferta in ofertasAtivas)
                {
                    if (oferta.idHamburguerNavigation == null) { continue; }
                    var item = oferta.idHamburguerNavigation;

                    <div class="BlocoHamburguer" style="margin-bottom: 30px;">
                        @if (!(item.HamburguerIgredientes.Any() && item.HamburguerIgredientes.All(i => i.IdIngredienteNavigation!.Quantidade >= i.QuantidadeNecessario)))
                        {
                            <h1 class="ForaDeEstoque">FORA DE ESTOQUE</h1>
                        }
                        <div class="FaixaHamburguer">@(oferta.porcentagem >= 30 ? "MEGA!!" : "OFERTA")</div>

                        <img src="@Html.DisplayFor(modelItem => item.Imagem)" class="ImagemHamburguer" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                        <h3 class="TituloHamburguer">@item.Nome</h3>

                        <p class="DescricaoHamburguer">@item.Descricao</p>

                        <div class="BottomInfoBurguer">
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div>
                                    <span style="text-decoration: line-through; color: #666; font-size: 0.9rem;">R$ @item.Preco</span>
                                    <h4 class="PrecoBurguer">R$ @oferta.precoFinal</h4>
                                </div>
                                <h3 class="PorcentagemOferta">-@oferta.porcentagem%</h3>
                            </div>

                            <div class="BotoesDoHamburguer">
                                @if (SignInManager.IsSignedIn(User))
                                {
                                    @if (item.HamburguerIgredientes.Any() && item.HamburguerIgredientes.All(i => i.IdIngredienteNavigation!.Quantidade >= i.QuantidadeNecessario))
                                    {
                                        <a class="CartBurguer" onclick="adicionarAoCarrinho('@item.Nome', @item.Preco, '@item.IdHamburguer', '@UserManager.GetUserName(User)', 'Hamburguer')">
                                            <i class="fas fa-shopping-cart"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <a class="CartBurguer">
                                            <i class="fas fa-shopping-cart"></i>
                                        </a>
                                    }
                                }
                                else
                                {
                                    <a class="CartBurguer" onclick="mostrarBotaoLogin()">
                                        <i class="fas fa-shopping-cart"></i>
                                    </a>
                                }
                                <a class="SaibaMaisHamburguer" asp-controller="Hamburgueres" asp-action="Details" asp-route-id="@item.IdHamburguer">DETALHES</a>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="width: 100%; text-align: center; padding: 50px; color: #777;">
                    <i class="fas fa-temperature-low" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <h3>Nenhuma oferta pegando fogo hoje.</h3>
                </div>
            }
        </div>

        <button class="next-slide" onclick="nextSlideOfertas()"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<div class="Content2 reveal" id="RecomendacoesDoChefe">
    <h1 class="section-title" style="color: white; text-shadow: 0 0 20px var(--primary);">SUGESTÕES DO CHEFE</h1>

    <div class="ConteudoRecomendacoesDoChefe">
        <div class="carrossel-wrapper">
            @foreach (var item in Model)
            {
                @if (item.Categoria == "Sugestão do chefe")
                {
                    <div class="item-recomendacao">
                        <img src="@item.Imagem" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                        <div class="info">
                            <div>
                                <h2 class="TituloRDC">@item.Nome</h2>
                                <p style="color: var(--text-light); opacity: 0.9; margin-bottom: 15px;">@item.Descricao</p>

                                <h5 style="font-weight: bold; font-size: 1.2rem; color: var(--accent); text-align: left; margin-top: 10px;">Ingredientes:</h5>
                                <ul class="lista-ingredientes">
                                    @foreach (var ingrediente in item.HamburguerIgredientes)
                                    {
                                        @if (ingrediente.IdIngredienteNavigation != null)
                                        {
                                            <li>@ingrediente.IdIngredienteNavigation.Nome</li>
                                        }
                                    }
                                </ul>
                            </div>

                            <div class="BotoesRDC">
                                @if (SignInManager.IsSignedIn(User))
                                {
                                    <a class="CartBurguer"
                                       onclick="adicionarAoCarrinho('@item.Nome', @item.Preco, '@item.IdHamburguer', '@UserManager.GetUserName(User)', 'Hamburguer')"
                                       title="Adicionar ao carrinho"
                                       style="width: 50%;">
                                        <i class="fas fa-shopping-cart cart-icon"></i>
                                        <span class="cart-text">Adicionar ao carrinho</span>
                                    </a>
                                }
                                else
                                {
                                    <a class="CartBurguer"
                                       onclick="mostrarBotaoLogin()"
                                       title="Adicionar ao carrinho"
                                       style="width: 50%;">
                                        <i class="fas fa-shopping-cart cart-icon"></i>
                                        <span class="cart-text">Adicionar ao carrinho</span>
                                    </a>
                                }

                                <a class="SaibaMaisHamburguer" asp-controller="Hamburgueres"
                                   asp-action="Details" asp-route-id="@item.IdHamburguer"
                                   style="width: 50%; background-color: var(--dark); border-radius: 20px;">
                                    Saiba Mais
                                </a>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>

        <button class="prev-slide" onclick="prevSlide()"><i class="fas fa-chevron-left"></i></button>
        <button class="next-slide" onclick="nextSlide()"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<div class="Content1" id="Cardapio" style="height: auto; padding-bottom: 80px;">
    <h2 class="section-title reveal">CARDÁPIO (DESTAQUES)</h2>

    <div class="CardapioCarrosselContainer reveal">

        <button class="prev-slide" onclick="prevSlideCardapio()"><i class="fas fa-chevron-left"></i></button>

        <div class="carrossel-cardapio" id="CardapioCarrossel">

            @foreach (var item in cardapioAleatorio)
            {
                // ===============================================
                // VERIFICADOR SOLICITADO: APENAS HAMBURGUERES
                // ===============================================
                @if (item.Tipo == "Hamburguer")
                {
                    // Lógica de Promoção e Estoque
                    var promocao = false;
                    decimal precoExibicao = item.Preco ?? 0;
                    TecBurguer.Models.Ofertas ofertaAplicada = null;

                    if (ofertasAtivas != null)
                    {
                        ofertaAplicada = ofertasAtivas.FirstOrDefault(o => o.idHamburguer == item.Id);
                        if (ofertaAplicada != null)
                        {
                            promocao = true;
                            precoExibicao = ofertaAplicada.precoFinal ?? 0;
                        }
                    }

                    // Só exibe aqui se NÃO for promoção (pois promoções têm sua própria área)
                    if (!promocao)
                    {
                        // Como já filtramos pelo if (Tipo == Hamburguer), fazemos o cast seguro
                        var h = item.ObjetoOriginal as TecBurguer.Models.Hamburguer;
                        bool temEstoque = h.HamburguerIgredientes.Any() && h.HamburguerIgredientes.All(i => i.IdIngredienteNavigation!.Quantidade >= i.QuantidadeNecessario);

                        <div class="BlocoHamburguer" style="margin-bottom: 30px;">

                            @if (!temEstoque)
                            {
                                <h1 class="ForaDeEstoque">FORA DE ESTOQUE</h1>
                            }

                            <img src="@item.Imagem" class="ImagemHamburguer" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                            <h3 class="TituloHamburguer">@item.Nome</h3>
                            <p class="DescricaoHamburguer">@item.Descricao</p>

                            <div class="BottomInfoBurguer">
                                <h4 class="PrecoBurguer">R$ @precoExibicao.ToString("N2")</h4>

                                <div class="BotoesDoHamburguer">
                                    @if (SignInManager.IsSignedIn(User))
                                    {
                                        if (temEstoque)
                                        {
                                            <a class="CartBurguer" onclick="adicionarAoCarrinho('@item.Nome', @item.Preco, '@item.Id', '@UserManager.GetUserName(User)')">
                                                <i class="fas fa-shopping-cart"></i>
                                            </a>
                                        }
                                        else
                                        {
                                            <a class="CartBurguer" style="opacity:0.5; cursor:not-allowed;">
                                                <i class="fas fa-ban"></i>
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        <a class="CartBurguer" onclick="mostrarBotaoLogin()">
                                            <i class="fas fa-shopping-cart"></i>
                                        </a>
                                    }

                                    <a class="SaibaMaisHamburguer" asp-controller="Hamburgueres" asp-action="Details" asp-route-id="@item.Id">VER MAIS</a>
                                </div>
                            </div>
                        </div>
                    }
                }
            }
        </div>
        <button class="next-slide" onclick="nextSlideCardapio()"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div style="text-align: center;">
        <a asp-controller="Home" asp-action="Cardapio" class="btn-ver-todos">
            ACESSAR CARDÁPIO COMPLETO <i class="fas fa-arrow-right"></i>
        </a>
    </div>
</div>

<div class="Content3" id="Bebidas" style="height: auto; padding-bottom: 50px;">
    <h2 class="section-title reveal">BEBIDAS GELADAS ❄️</h2>

    <div class="BebidasCarrosselContainer reveal">
        <button class="prev-slide" onclick="prevSlideBebidas()"><i class="fas fa-chevron-left"></i></button>

        <div class="carrossel-cardapio" id="BebidasCarrossel">

            @foreach (var bebida in bebidas)
            {

                Console.WriteLine(bebida.IdBebidas);

                bool temEstoque = (bebida.Quantidade ?? 0) > 0;

                <div class="BlocoHamburguer" style="margin-bottom: 30px;">

                    @if (!temEstoque)
                    {
                        <h1 class="ForaDeEstoque">ESGOTADO</h1>
                    }

                    <img src="@bebida.Imagem" class="ImagemHamburguer" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                    <h3 class="TituloHamburguer">@bebida.Nome</h3>
                    <p class="DescricaoHamburguer">Bebida refrescante.</p>

                    <div class="BottomInfoBurguer">
                        <h4 class="PrecoBurguer">R$ @(bebida.Preco?.ToString("N2"))</h4>

                        <div class="BotoesDoHamburguer">
                            @if (SignInManager.IsSignedIn(User))
                            {
                                if (temEstoque)
                                {
                                    <a class="CartBurguer" onclick="adicionarAoCarrinho('@bebida.Nome', @bebida.Preco, '@bebida.IdBebidas', '@UserManager.GetUserName(User)', 'Bebida')">
                                        <i class="fas fa-shopping-cart"></i>
                                    </a>
                                }
                                else
                                {
                                    <a class="CartBurguer" style="opacity:0.5; cursor:not-allowed;"><i class="fas fa-ban"></i></a>
                                }
                            }
                            else
                            {
                                <a class="CartBurguer" onclick="mostrarBotaoLogin()">
                                    <i class="fas fa-shopping-cart"></i>
                                </a>
                            }

                            <a class="SaibaMaisHamburguer" style="opacity:0.5; cursor:default;">BEBIDA</a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <button class="next-slide" onclick="nextSlideBebidas()"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<div id="FacaLogin">
    <img src="~/css/Imagens/BurguerLogo.png" alt="Logo">
    <div style="flex-grow: 1;">
        @if (SignInManager.IsSignedIn(User))
        {
            <h3>Calma lá! 🍔</h3>
            <p>O seu pedido já está em preparo ou à caminho, aguarde alguns minutos.</p>
            <div style="margin-top: 10px;">
                <a class="BotaoLogin" asp-area="" asp-controller="Home" asp-action="Cart">Ir para Carrinho</a>
            </div>
        }
        else
        {
            <h3>Psiu! 🍔</h3>
            <p>Faça login para continuar.</p>
            <div style="margin-top: 10px; display: flex;">
                <a class="BotaoCriarConta" asp-area="Identity" asp-page="/Account/Register">Criar conta</a>
                <a class="BotaoLogin" asp-area="Identity" asp-page="/Account/Login">Login</a>
            </div>
        }
    </div>
    <button onclick="fecharPopup()" style="background: transparent; border: none; font-size: 1.2rem; cursor: pointer; color: #333;">&times;</button>
</div>

<div id="LoadingOverlay">
    <div class="loading-content">

        <div class="reactor-loader">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>

            <div class="icon-center">
                <i class="fas fa-hamburger icon-burger"></i>
                <i class="fas fa-shopping-cart icon-cart"></i>
            </div>
        </div>

        <h3 class="loading-text">PREPARANDO PEDIDO...</h3>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="~/js/site.js"></script>

<script>
    const cardapioCarrossel = document.getElementById('CardapioCarrossel');
    const scrollAmount = 650;

    function prevSlideCardapio() {
        if (cardapioCarrossel) {
            cardapioCarrossel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        }
    }

    function nextSlideCardapio() {
        if (cardapioCarrossel) {
            cardapioCarrossel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }

    const ofertasCarrossel = document.getElementById('OfertasCarrossel');

    function prevSlideOfertas() {
        if (ofertasCarrossel) {
            ofertasCarrossel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        }
    }

    function nextSlideOfertas() {
        if (ofertasCarrossel) {
            ofertasCarrossel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }

    window.addEventListener('scroll', reveal);
    function reveal() {
        var reveals = document.querySelectorAll('.reveal');
        for (var i = 0; i < reveals.length; i++) {
            var windowheight = window.innerHeight;
            var revealtop = reveals[i].getBoundingClientRect().top;
            var revealpoint = 150;
            if (revealtop < windowheight - revealpoint) {
                reveals[i].classList.add('active');
            }
        }
    }
    reveal();

    document.querySelectorAll('.BlocoHamburguer').forEach(card => {
        card.addEventListener('mousemove', e => {
            let rect = card.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            let centerX = rect.width / 2;
            let centerY = rect.height / 2;

            let rotateX = ((y - centerY) / centerY) * -10;
            let rotateY = ((x - centerX) / centerX) * 10;
            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
        });

        card.addEventListener('mouseleave', () => {
            card.style.transform = `perspective(1000px) rotateX(0) rotateY(0) scale(1)`;
        });
    });

    // function hideLoading() {
    //     const overlay = document.getElementById('LoadingOverlay');
    //     const wrapper = document.querySelector('.icon-wrapper');

    //     clearInterval(loadingInterval);
    //     overlay.classList.remove('active');
    //     wrapper.classList.remove('show-cart');
    // }
</script>