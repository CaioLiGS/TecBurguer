@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data
@using Microsoft.EntityFrameworkCore

@model IEnumerable<TecBurguer.Models.Pedido>

@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager
@inject TecBurguer.Models.DBTecBurguerContext _context

@{
    ViewData["Title"] = "Carrinho de Compras";

    // Busca ofertas ativas
    var ofertasAtivas = _context.Ofertas
        .Where(o => DateTime.Now < o.dataTermino)
        .ToList();

    var pedido = Model.FirstOrDefault();

    List<dynamic> itemsDoCarrinho = new List<dynamic>();

    TecBurguer.Models.Pedido pedidoDoUsuario = null;

    foreach (var item in Model)
    {
        if (item.IdUsuarioNavigation?.Email == UserManager.GetUserName(User))
        {
            pedidoDoUsuario = item;
            if (item.Estado == "Decidindo")
            {
                foreach (var ph in item.PedidoHamburgueres)
                {
                    itemsDoCarrinho.Add(new
                    {
                        Tipo = "Hamburguer",
                        IdItemPedido = ph.Id,
                        IdProduto = ph.IdHamburguer,
                        Quantidade = ph.Quantidade,
                        Nome = ph.IdHamburguerNavigation.Nome,
                        PrecoOriginal = ph.IdHamburguerNavigation.Preco,
                        Imagem = ph.IdHamburguerNavigation.Imagem,
                        ObjetoOriginal = ph.IdHamburguerNavigation
                    });
                }

                var bebidasDoPedido = _context.PedidoBebidas
                    .Where(pb => pb.IdPedido == item.IdPedido)
                    .Include(pb => pb.IdBebidasNavigation)
                    .ToList();

                foreach (var pb in bebidasDoPedido)
                {
                    itemsDoCarrinho.Add(new
                    {
                        Tipo = "Bebida",
                        IdItemPedido = pb.Id,
                        IdProduto = pb.IdBebidas,
                        Quantidade = pb.Quantidade,
                        Nome = pb.IdBebidasNavigation.Nome,
                        PrecoOriginal = pb.IdBebidasNavigation.Preco,
                        Imagem = pb.IdBebidasNavigation.Imagem,
                        ObjetoOriginal = pb.IdBebidasNavigation
                    });
                }
            }
        }
    }
    pedido = pedidoDoUsuario;
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ranchers&family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel="stylesheet" href="/css/Cart.css">

<div class="cart-container">
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container">
        <h1 class="page-title">SEU CARRINHO 🔥</h1>

        @if (pedido != null && pedido.Estado == "Cozinhando")
        {
            <div class="alert alert-warning text-center" style="background: rgba(255, 193, 7, 0.2); border-color: var(--accent); color: white;">
                <h4 style="margin:0;">🔥 PEDIDO EM PREPARO!</h4>
                <p>O pedido #@pedido.IdPedido já está na chapa e não pode ser alterado.</p>
            </div>
        }

        @if (!itemsDoCarrinho.Any() && (pedido == null || pedido.Estado != "Cozinhando"))
        {
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart" style="font-size: 5rem; color: #333; margin-bottom: 20px;"></i>
                <h3 style="color: #777;">Seu carrinho está vazio.</h3>
                <a href="/" class="btn-checkout" style="display: inline-block; width: auto; padding: 10px 30px; text-decoration: none;">Ver Cardápio</a>
            </div>
        }
        else if (itemsDoCarrinho.Any())
        {
            <div class="row">
                <div class="col-lg-8">
                    @foreach (var item in itemsDoCarrinho)
                    {
                        decimal precoUnitario = item.PrecoOriginal ?? 0;
                        decimal precoFinal = precoUnitario;
                        TecBurguer.Models.Ofertas ofertaAplicada = null;

                        if (item.Tipo == "Hamburguer" && ofertasAtivas != null)
                        {
                            ofertaAplicada = ofertasAtivas.FirstOrDefault(o => o.idHamburguer == item.IdProduto);
                            if (ofertaAplicada != null)
                            {
                                var desconto = (precoUnitario * ofertaAplicada.porcentagem ?? 0) / 100;
                                precoFinal = precoUnitario - desconto;
                            }
                        }

                        <div class="cart-item">
                            <img src="@(item.Imagem ?? "/css/Imagens/BurguerLogo.png")" alt="@item.Nome" class="item-image" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                            <div class="flex-grow-1">
                                <div class="item-details">
                                    <h5>@item.Nome</h5>

                                    <div class="price-info">
                                        @if (ofertaAplicada != null)
                                        {
                                            <span class="old-price">R$ @precoUnitario.ToString("N2")</span>
                                            <div>
                                                <span class="current-price">R$ @precoFinal.ToString("N2")</span>
                                                <span class="discount-badge">-@ofertaAplicada.porcentagem%</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="current-price">R$ @precoUnitario.ToString("N2")</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center">
                                <div class="quantity-controls me-3">
                                    @if (item.Tipo == "Hamburguer")
                                    {
                                        <button class="quantity-btn" onclick="RemoverQuantidadeHamburguerPedido(@item.IdItemPedido)">-</button>
                                    }
                                    else
                                    {
                                        <button class="quantity-btn" onclick="RemoverQuantidadeBebidaPedido(@item.IdItemPedido)">-</button>
                                    }

                                    <span class="quantity-input">@item.Quantidade</span>

                                    @if (item.Tipo == "Hamburguer")
                                    {
                                        <button class="quantity-btn" onclick="adicionarAoCarrinho('@item.Nome', @precoUnitario.ToString(System.Globalization.CultureInfo.InvariantCulture), '@item.IdProduto', '@UserManager.GetUserName(User)', 'Hamburguer')">+</button>
                                    }
                                    else
                                    {
                                        <button class="quantity-btn" onclick="adicionarAoCarrinho('@item.Nome', @precoUnitario.ToString(System.Globalization.CultureInfo.InvariantCulture), '@item.IdProduto', '@UserManager.GetUserName(User)', 'Bebida')">+</button>
                                    }
                                </div>

                                <div style="min-width: 100px; text-align: right;">
                                    <h6 class="mb-0" style="color: var(--accent); font-weight: bold;">
                                        R$ @((item.Quantidade * precoFinal).ToString("N2"))
                                    </h6>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="col-lg-4">
                    <div class="summary-card">
                        <h3 class="summary-title">RESUMO</h3>

                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="cart-subtotal">R$ @pedido?.PrecoTotal?.ToString("N2")</span>
                        </div>
                        <div class="summary-row">
                            <span>Frete</span>
                            <span style="color: var(--accent);">Grátis</span>
                        </div>

                        <div class="summary-row total-row">
                            <span>TOTAL</span>
                            <span id="cart-total" style="font-size: 2rem; color: var(--primary);">
                                R$ @pedido?.PrecoTotal?.ToString("N2")
                            </span>
                        </div>

                        <button class="btn-checkout" onclick="FinalizarCompra('@UserManager.GetUserName(User)', @pedido?.IdPedido)">
                            FINALIZAR COMPRA
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<div id="PopUpNaoTemCEP">
    <div class="popup-content glass-panel">
        <h3 style="color: var(--primary); font-family: 'Ranchers';">ENTREGA 🚀</h3>
        <p style="color: #ccc;">Informe seu CEP para confirmarmos a entrega.</p>
        <div class="mb-3">
            <input type="text" class="form-control" id="cepInput" placeholder="00000-000" maxlength="9">
        </div>
        <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-secondary" onclick="FecharPopUp()">Cancelar</button>
            <button class="btn-checkout" style="margin-top:0; width: auto;" onclick="FinalizarCompra('@UserManager.GetUserName(User)', @pedido?.IdPedido)">Confirmar</button>
        </div>
    </div>
</div>

<div id="LoadingOverlay">
    <div class="loading-content">
        <div class="reactor-loader">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="icon-center">
                <i class="fas fa-hamburger icon-burger"></i>
                <i class="fas fa-shopping-cart icon-cart"></i>
            </div>
        </div>
        <h3 class="loading-text">ATUALIZANDO...</h3>
    </div>
</div>

<script>
    window.ofertasAtivasGlobais = @Json.Serialize(ofertasAtivas.Select(o => new { idHamburguer = o.idHamburguer, porcentagem = o.porcentagem }));

    function FecharPopUp() {
        document.getElementById("PopUpNaoTemCEP").classList.remove("Aparecer");
    }

</script>
