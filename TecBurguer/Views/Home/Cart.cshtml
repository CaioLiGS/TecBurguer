@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data

@model IEnumerable<TecBurguer.Models.Pedido>

@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager

@{
    ViewData["Title"] = "Carrinho de Compras";
    var pedido = Model.FirstOrDefault();
    List<dynamic> itemsDoCarrinho = new List<dynamic>();
    foreach (var item in Model)
    {
        Console.WriteLine(item.IdUsuarioNavigation?.Email);
        Console.WriteLine(UserManager.GetUserName(User));
        if (item.IdUsuarioNavigation?.Email == UserManager.GetUserName(User))
        {

            pedido = item;

            foreach (var hamburguer in item.PedidoHamburgueres)
            {
                if (item.Estado == "Decidindo") {
                    itemsDoCarrinho.Add(hamburguer);
                }
            }
        }
    }
}

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel="stylesheet" href="~/css/Cart.css">

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Seu Carrinho</h1>
        </div>

        @if (!itemsDoCarrinho.Any())
        {
            <div class="col-12">
                <div class="alert alert-info" role="alert">Seu carrinho está vazio.</div>
            </div>
        }
        else
        {
            <div class="col-lg-8">
                <div id="cart-items-container" class="list-group shadow-sm">
                    @foreach (var hamburguer in itemsDoCarrinho)
                    {
                        var precoUnitario = hamburguer.IdHamburguerNavigation.Preco;
                        <div class="list-group-item d-flex flex-wrap align-items-center p-3">
                            <img src="@(hamburguer.IdHamburguerNavigation.Imagem ?? "/images/placeholder.png")" alt="@hamburguer.IdHamburguerNavigation.Nome" class="item-image rounded">
                            <div class="flex-grow-1 me-3" style="min-width: 150px;">
                                <h5 class="mb-1">@hamburguer.IdHamburguerNavigation.Nome</h5>
                                <small class="text-muted">R$ @hamburguer.IdHamburguerNavigation.Preco</small>
                            </div>

                            <div class="quantity-controls my-2 me-3" role="group" aria-label="Controles de quantidade">
                                <button class="btn quantity-btn btn-decrease" data-id="@hamburguer.Id" aria-label="Diminuir quantidade" onclick="RemoverQuantidadeHamburguerPedido(@hamburguer.Id, @hamburguer.IdHamburguerNavigation.Preco)">-</button>
                                <span class="quantity-input" id="qty_@hamburguer.Id" aria-live="polite">@hamburguer.Quantidade</span>
                                <button class="btn quantity-btn btn-increase" data-id="@hamburguer.Id" aria-label="Aumentar quantidade" onclick="adicionarAoCarrinho('@hamburguer.IdHamburguerNavigation.Nome',@hamburguer.IdHamburguerNavigation.Preco,'@hamburguer.IdHamburguer','@UserManager.GetUserName(User)', true)">+</button>
                            </div>

                            <div class="ms-lg-auto" style="min-width: 100px;">
                                <h6 class="mb-0 text-lg-end" id="itemSubtotal_@hamburguer.Id">R$ @(hamburguer.Quantidade * precoUnitario)</h6>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="col-lg-4 mt-4 mt-lg-0">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Resumo do Pedido</h4>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span id="cart-subtotal">R$ @pedido?.PrecoTotal</span>
                        </div>

                        <div class="d-flex justify-content-between mb-3">
                            <span>Frete</span>
                            <span>Grátis</span>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between fw-bold fs-5 mb-4">
                            <span>Total</span>
                            <span id="cart-total">R$ @pedido?.PrecoTotal</span>
                        </div>

                        <!-- Botão Finalizar dentro do resumo (chamada inline segura) -->
                        <button id="finalizarPedidoBtnInline" type="button" class="btn btn-primary w-100"
                                onclick="FinalizarCompra('@UserManager.GetUserName(User)', @pedido?.IdPedido)" style="display: block;">
                            Finalizar Compra
                        </button>

                    </div>

                    <div class="card-footer bg-transparent border-0">
                        <!-- Mantive card-footer (pode ficar vazio ou conter info adicional) -->
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal Bootstrap para CEP -->
<div class="modal fade" id="cepModal" tabindex="-1" aria-labelledby="cepModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cepModalLabel">Finalizar Pedido - Informe seu CEP</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p>Por favor, informe o CEP para prosseguir com a finalização do pedido.</p>
        <div class="mb-3">
            <label for="cepInput" class="form-label">CEP</label>
            <input type="text" class="form-control" id="cepInput" placeholder="Ex: 01234567" maxlength="9" inputmode="numeric" pattern="\d*">
            <div id="cepError" class="text-danger mt-2" style="display:block;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="ConfirmarFinalizacao()">Confirmar</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            // garante que exista valor seguro do email no JS
            window.__finalizarUserEmail = @System.Text.Json.JsonSerializer.Serialize(UserManager.GetUserName(User) ?? "");

            // anexo redundante (fallback) caso queira usar evento em vez de onclick inline
            function attach() {
                const btn = document.getElementById('finalizarPedidoBtn');
                if (!btn) return;
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    if (typeof FinalizarCompra === 'function') {
                        FinalizarCompra(window.__finalizarUserEmail);
                    } else {
                        const modalEl = document.getElementById('cepModal');
                        if (modalEl && window.bootstrap) new bootstrap.Modal(modalEl).show();
                        else alert('Função de finalizar indisponível. Verifique console.');
                    }
                });
            }

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attach);
            else attach();
        })();
    </script>
}
