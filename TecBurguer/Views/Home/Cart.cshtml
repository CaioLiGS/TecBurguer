@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data

@model IEnumerable<TecBurguer.Models.Pedido>

@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager

@{
    ViewData["Title"] = "Carrinho de Compras";
    var pedido = Model.FirstOrDefault(); // Inicializa com o primeiro, ou null
    List<dynamic> itemsDoCarrinho = new List<dynamic>();

    // Variável para armazenar o pedido do usuário logado (se houver um no estado "Decidindo" ou "Cozinhando")
    TecBurguer.Models.Pedido pedidoDoUsuario = null;

    foreach (var item in Model)
    {
        // Verifica se o pedido pertence ao usuário logado
        if (item.IdUsuarioNavigation?.Email == UserManager.GetUserName(User))
        {
            // Encontramos o pedido do usuário
            pedidoDoUsuario = item;

            // Se o estado for "Decidindo", adiciona os itens para exibição no carrinho de compras
            if (item.Estado == "Decidindo")
            {
                foreach (var hamburguer in item.PedidoHamburgueres)
                {
                    itemsDoCarrinho.Add(hamburguer);
                }
            }
        }
    }
    // Usa o pedidoDoUsuario encontrado
    pedido = pedidoDoUsuario;
}

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel="stylesheet" href="/css/Cart.css">

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Seu Carrinho</h1>
        </div>

        @* NOVO BLOCO: Mensagem para Pedido em Preparação ("Cozinhando") *@
        @if (pedido != null && pedido.Estado == "Cozinhando")
        {
            <div class="col-12 mb-4">
                <div class="alert alert-warning text-center" role="alert">
                    🍔 Seu pedido (Nº @pedido.IdPedido) está sendo preparado e não pode mais ser alterado.
                </div>
                <div class="d-grid gap-2">
                    @* ALTERADO: Link substituído por botão que chama JS e usa Bootstrap Collapse *@
                    <button id="btnDetalhesPedido" type="button" class="btn btn-outline-info"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseDetalhes_@pedido.IdPedido"
                            aria-expanded="false"
                            aria-controls="collapseDetalhes_@pedido.IdPedido"
                            onclick="carregarDetalhesPedido(@pedido.IdPedido)">
                        Ver Detalhes do Pedido
                    </button>
                </div>

                @* NOVO ELEMENTO: Área para injetar os detalhes via JS *@
                <div class="collapse mt-3" id="collapseDetalhes_@pedido.IdPedido">
                    <div id="detalhesPedido_@pedido.IdPedido" class="card card-body">
                        Clique em "Ver Detalhes" para carregar os itens.
                    </div>
                </div>
            </div>
        }
        @* -------------------------------------------------------- *@

        @* Condição: O carrinho está VAZIO (itemsDoCarrinho.Any() é false) E o pedido NÃO está sendo cozinhado. *@
        @if (!itemsDoCarrinho.Any() && (pedido == null || pedido.Estado != "Cozinhando"))
        {
            <div class="col-12">
                <div class="alert alert-info" role="alert">Seu carrinho está vazio.</div>
            </div>
        }
        @* Condição: O carrinho tem ITENS. Isso implica que o estado é "Decidindo". *@
        else if (itemsDoCarrinho.Any())
        {
            <div class="col-lg-8">
                <div id="cart-items-container" class="list-group shadow-sm">
                    @foreach (var hamburguer in itemsDoCarrinho)
                    {
                        var precoUnitario = hamburguer.IdHamburguerNavigation.Preco;
                        <div class="list-group-item d-flex flex-wrap align-items-center p-3">
                            <img src="@(hamburguer.IdHamburguerNavigation.Imagem ?? "/images/placeholder.png")" alt="@hamburguer.IdHamburguerNavigation.Nome" class="item-image rounded">
                            <div class="flex-grow-1 me-3" style="min-width: 150px;">
                                <h5 class="mb-1">@hamburguer.IdHamburguerNavigation.Nome</h5>
                                <small class="text-muted">R$ @hamburguer.IdHamburguerNavigation.Preco</small>
                            </div>

                            <div class="quantity-controls my-2 me-3" role="group" aria-label="Controles de quantidade">
                                <button class="btn quantity-btn btn-decrease" data-id="@hamburguer.Id" aria-label="Diminuir quantidade" onclick="RemoverQuantidadeHamburguerPedido(@hamburguer.Id, @hamburguer.IdHamburguerNavigation.Preco)">-</button>
                                <span class="quantity-input" id="qty_@hamburguer.Id" aria-live="polite">@hamburguer.Quantidade</span>
                                <button class="btn quantity-btn btn-increase" data-id="@hamburguer.Id" aria-label="Aumentar quantidade" onclick="adicionarAoCarrinho('@hamburguer.IdHamburguerNavigation.Nome',@hamburguer.IdHamburguerNavigation.Preco,'@hamburguer.IdHamburguer','@UserManager.GetUserName(User)', true)">+</button>
                            </div>

                            <div class="ms-lg-auto" style="min-width: 100px;">
                                <h6 class="mb-0 text-lg-end" id="itemSubtotal_@hamburguer.Id">R$ @(hamburguer.Quantidade* precoUnitario)</h6>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="col-lg-4 mt-4 mt-lg-0">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Resumo do Pedido</h4>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span id="cart-subtotal">R$ @pedido?.PrecoTotal</span>
                        </div>

                        <div class="d-flex justify-content-between mb-3">
                            <span>Frete</span>
                            <span>Grátis</span>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between fw-bold fs-5 mb-4">
                            <span>Total</span>
                            <span id="cart-total">R$ @pedido?.PrecoTotal</span>
                        </div>

                        <button id="finalizarPedidoBtnInline" type="button" class="btn btn-primary w-100"
                                onclick="FinalizarCompra('@UserManager.GetUserName(User)', @pedido?.IdPedido)" style="display: block;">
                            Finalizar Compra
                        </button>

                    </div>

                    <div class="card-footer bg-transparent border-0">
                    </div>
                </div>
            </div>
        }
    </div>

</div>

<div id="PopUpNaoTemCEP">

    <div class="popup-dialog">

        <div class="popup-content">

            <div class="popup-body">
                <p>Por favor, informe o CEP para prosseguir com a finalização do pedido.</p>
                <div class="mb-3">
                    <label for="cepInput" class="form-label">CEP</label>
                    <input type="text" class="form-control" id="cepInput" placeholder="Ex: 01234567" maxlength="9" inputmode="numeric" pattern="\d*">
                    <div id="cepError" class="text-danger mt-2" style="display:block;"></div>
                </div>
            </div>

            <div class="popup-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="FecharPopUp()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="FinalizarCompra('@UserManager.GetUserName(User)', @pedido?.IdPedido)">Confirmar</button>
            </div>

        </div>
    </div>
</div>