@using Microsoft.AspNetCore.Identity
@using TecBurguer.Areas.Identity.Data
@using Microsoft.EntityFrameworkCore

@model IEnumerable<TecBurguer.Models.Pedido>

@inject UserManager<LoginCliente> UserManager
@inject SignInManager<LoginCliente> SignInManager
@inject TecBurguer.Models.DBTecBurguerContext _context

@{
    ViewData["Title"] = "Carrinho de Compras";

    var ofertasAtivas = _context.Ofertas
        .Where(o => DateTime.Now < o.dataTermino)
        .ToList();

    List<dynamic> itemsDoCarrinho = new List<dynamic>();
    TecBurguer.Models.Pedido pedidoDoUsuario = null;

    foreach (var item in Model)
    {
        if (item.IdUsuarioNavigation?.Email == UserManager.GetUserName(User))
        {
            if (item.Estado == "Decidindo" || item.Estado == "Cozinhando" || item.Estado == "Para ser entregue" || item.Estado == "Saiu para entrega")
            {
                pedidoDoUsuario = item;

                foreach (var ph in item.PedidoHamburgueres)
                {
                    itemsDoCarrinho.Add(new
                    {
                        Tipo = "Hamburguer",
                        IdItemPedido = ph.Id,
                        IdProduto = ph.IdHamburguer,
                        Quantidade = ph.Quantidade,
                        Nome = ph.IdHamburguerNavigation.Nome,
                        PrecoOriginal = ph.IdHamburguerNavigation.Preco,
                        Imagem = ph.IdHamburguerNavigation.Imagem
                    });
                }

                // Carrega Bebidas
                var bebidasDoPedido = _context.PedidoBebidas
                    .Where(pb => pb.IdPedido == item.IdPedido)
                    .Include(pb => pb.IdBebidasNavigation)
                    .ToList();

                foreach (var pb in bebidasDoPedido)
                {
                    itemsDoCarrinho.Add(new
                    {
                        Tipo = "Bebida",
                        IdItemPedido = pb.Id,
                        IdProduto = pb.IdBebidas,
                        Quantidade = pb.Quantidade,
                        Nome = pb.IdBebidasNavigation.Nome,
                        PrecoOriginal = pb.IdBebidasNavigation.Preco,
                        Imagem = pb.IdBebidasNavigation.Imagem
                    });
                }

                // Se achou um pedido ativo, para o loop (assume 1 pedido ativo por vez)
                break;
            }
        }
    }

    var pedido = pedidoDoUsuario;

    // 2. VARIÁVEL DE CONTROLE: Define se é apenas visualização
    bool modoLeitura = (pedido != null && pedido.Estado != "Decidindo");
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ranchers&family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel="stylesheet" href="/css/Cart.css">


<div class="cart-container">
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container">
        <h1 class="page-title">
            @if (modoLeitura)
            {
                <span style="color:var(--accent)">ACOMPANHAR PEDIDO</span>
            }
            else
            {

                <span>SEU CARRINHO</span>
            }
        </h1>

        @if (pedido != null)
        {
            if (pedido.Estado == "Cozinhando")
            {
                <div class="status-banner cooking">
                    <i class="fas fa-fire-alt fa-2x"></i>
                    <div>
                        <h4>PREPARANDO SEU PEDIDO!</h4>
                        <p>A chapa está quente! Seus itens estão sendo preparados com carinho.</p>
                    </div>
                </div>
            }
            else if (pedido.Estado == "Para ser entregue")
            {
                <div class="status-banner delivery">
                    <i class="fas fa-motorcycle fa-2x"></i>
                    <div>
                        <h4>PEDIDO PRONTO!</h4>
                        <p>O seu pedido já está pronto, aguardando um etregador pega-lo.</p>
                    </div>
                </div>
            }
            else if (pedido.Estado == "Saiu para entrega")
            {
                <div class="status-banner delivery">
                    <i class="fas fa-motorcycle fa-2x"></i>
                    <div>
                        <h4>PEDIDO A CAMINHO!</h4>
                        <p>O entregador está com toda a velocidade a caminho da sua residência com o seu pedido.</p>
                    </div>
                </div>
            }
        }

        @if(pedido != null && pedido.Estado != "Decidindo")
        {
            <div class="status-banner cooking">
                <i class="fas fa-fire-alt fa-2x"></i>
                <div>
                    <h4>CÓDIGO DE SEGURANÇA: @pedido.Nome</h4>
                    <p>Quando o entregador chegar na sua residência, informe o seu código para confirmar a entrega</p>
                </div>
            </div>
        }

        @if (!itemsDoCarrinho.Any() && (pedido == null))
        {
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart" style="font-size: 5rem; color: #333; margin-bottom: 20px;"></i>
                <h3 style="color: #777;">Seu carrinho está vazio.</h3>
                <a href="/" class="btn-checkout" style="display: inline-block; width: auto; padding: 10px 30px; text-decoration: none;">Ver Cardápio</a>
            </div>
        }
        else if (itemsDoCarrinho.Any())
        {
            <div class="row">
                <div class="col-lg-8">
                    @foreach (var item in itemsDoCarrinho)
                    {
                        decimal precoUnitario = item.PrecoOriginal ?? 0;
                        decimal precoFinal = precoUnitario;
                        TecBurguer.Models.Ofertas ofertaAplicada = null;

                        if (item.Tipo == "Hamburguer" && ofertasAtivas != null)
                        {
                            ofertaAplicada = ofertasAtivas.FirstOrDefault(o => o.idHamburguer == item.IdProduto);
                            if (ofertaAplicada != null)
                            {
                                var desconto = (precoUnitario * (ofertaAplicada.porcentagem ?? 0)) / 100;
                                precoFinal = precoUnitario - desconto;
                            }
                        }

                        <div class="cart-item @(modoLeitura ? "readonly-item" : "")">
                            <img src="@(item.Imagem ?? "/css/Imagens/BurguerLogo.png")" alt="@item.Nome" class="item-image" onerror="this.src='/css/Imagens/BurguerLogo.png'">

                            <div class="flex-grow-1">
                                <div class="item-details">
                                    <h5>@item.Nome <small style="font-size: 0.8rem; color: #888;">(@item.Tipo)</small></h5>

                                    <div class="price-info">
                                        @if (ofertaAplicada != null)
                                        {
                                            <span class="old-price">R$ @precoUnitario.ToString("N2")</span>
                                            <div>
                                                <span class="current-price">R$ @precoFinal.ToString("N2")</span>
                                                <span class="discount-badge">-@ofertaAplicada.porcentagem%</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="current-price">R$ @precoUnitario.ToString("N2")</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center">
                                @if (!modoLeitura)
                                {
                                    <div class="quantity-controls me-3">
                                        @if (item.Tipo == "Hamburguer")
                                        {
                                            <button class="quantity-btn" onclick="RemoverQuantidadeHamburguerPedido(@item.IdItemPedido)">-</button>
                                        }
                                        else
                                        {
                                            <button class="quantity-btn" onclick="RemoverQuantidadeBebidaPedido(@item.IdItemPedido)">-</button>
                                        }

                                        <span class="quantity-input">@item.Quantidade</span>

                                        @if (item.Tipo == "Hamburguer")
                                        {
                                            <button class="quantity-btn" onclick="adicionarAoCarrinho('@item.Nome', @precoUnitario.ToString(System.Globalization.CultureInfo.InvariantCulture), '@item.IdProduto', '@UserManager.GetUserName(User)', 'Hamburguer')">+</button>
                                        }
                                        else
                                        {
                                            <button class="quantity-btn" onclick="adicionarAoCarrinho('@item.Nome', @precoUnitario.ToString(System.Globalization.CultureInfo.InvariantCulture), '@item.IdProduto', '@UserManager.GetUserName(User)', 'Bebida')">+</button>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="quantity-display me-4">
                                        <span style="color: #aaa; font-size: 0.9rem;">Qtd:</span>
                                        <span style="color: white; font-weight: bold; font-size: 1.2rem;">@item.Quantidade</span>
                                    </div>
                                }

                                <div style="min-width: 100px; text-align: right;">
                                    <h6 class="mb-0" style="color: var(--accent); font-weight: bold;">
                                        R$ @((item.Quantidade * precoFinal).ToString("N2"))
                                    </h6>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="col-lg-4">
                    <div class="summary-card">
                        <h3 class="summary-title">RESUMO</h3>

                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="cart-subtotal">R$ @pedido?.PrecoTotal?.ToString("N2")</span>
                        </div>
                        <div class="summary-row">
                            <span>Frete</span>
                            <span style="color: var(--accent);">Grátis</span>
                        </div>

                        <div class="summary-row" style="border-top: 1px dashed rgba(255,255,255,0.1); margin-top: 10px; padding-top: 10px;">
                            <span>Status</span>
                            <span style="color: @(pedido.Estado == "Decidindo" ? "#aaa" : "var(--primary)"); font-weight: bold;">
                                @pedido.Estado.ToUpper()
                            </span>
                        </div>

                        <div class="summary-row total-row">
                            <span>TOTAL</span>
                            <span id="cart-total" style="font-size: 2rem; color: var(--primary);">
                                R$ @pedido?.PrecoTotal?.ToString("N2")
                            </span>
                        </div>

                        @if (!modoLeitura)
                        {
                            <button class="btn-checkout" onclick="FinalizarCompra('@UserManager.GetUserName(User)', @pedido?.IdPedido)">
                                FINALIZAR COMPRA
                            </button>
                        }
                        else
                        {
                            <button class="btn-checkout" style="background: #333; cursor: default; border: 1px solid #555;">
                                <i class="fas fa-clock"></i> AGUARDE A ENTREGA
                            </button>
                            <p style="text-align:center; font-size: 0.8rem; color: #777; margin-top: 10px;">
                                O pedido já foi processado e não pode ser alterado.
                            </p>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>


<div id="PopUpNaoTemCEP">
    <div class="popup-content">
        <h3 class="popup-title">
            <i class="fas fa-shipping-fast"></i> ENTREGA
        </h3>

        <div class="mb-4 position-relative">
            <label class="form-label-custom">CEP</label>
            <div style="position:relative;">
                <input type="text" class="input-dark" id="cepInput" placeholder="00000-000" maxlength="9" onblur="BuscarEndereco(this.value)" style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#666;"></i>
            </div>
            <span id="msgErroCep" class="text-danger small mt-1" style="display:none; position:absolute;">
                <i class="fas fa-times-circle"></i> CEP não encontrado.
            </span>
        </div>

        <div class="row g-2 mb-4">
            <div class="col-9">
                <input type="text" id="ruaInput" class="input-dark" placeholder="Rua..." readonly>
            </div>
            <div class="col-3">
                <input type="text" id="ufInput" class="input-dark text-center" placeholder="UF" readonly>
            </div>
            <div class="col-5">
                <input type="text" id="bairroInput" class="input-dark" placeholder="Bairro" readonly>
            </div>
            <div class="col-7">
                <input type="text" id="cidadeInput" class="input-dark" placeholder="Cidade" readonly>
            </div>
        </div>

        <div class="toggle-container">
            <button type="button" class="btn-toggle active" id="btnCasa" onclick="AlternarMoradia('casa')">
                <i class="fas fa-home"></i> CASA
            </button>
            <button type="button" class="btn-toggle" id="btnApto" onclick="AlternarMoradia('apto')">
                <i class="fas fa-building"></i> APARTAMENTO
            </button>
        </div>

        <div id="areaCasa" class="fade-in">
            <div class="mb-3">
                <label class="form-label-custom">NÚMERO</label>
                <input type="text" id="numCasaInput" class="input-dark" placeholder="Ex: 123 A">
            </div>
        </div>

        <div id="areaApto" style="display:none;" class="fade-in">
            <div class="mb-2">
                <label class="form-label-custom">NOME DO CONDOMÍNIO</label>
                <input type="text" id="condominioInput" class="input-dark" placeholder="Ex: Residencial Flores">
            </div>
            <div class="row g-2">
                <div class="col-4">
                    <input type="text" id="blocoInput" class="input-dark text-center" placeholder="Bloco">
                </div>
                <div class="col-4">
                    <input type="text" id="andarInput" class="input-dark text-center" placeholder="Andar">
                </div>
                <div class="col-4">
                    <input type="text" id="numAptoInput" class="input-dark text-center" placeholder="Nº Apto">
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-4 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
            <button class="btn-cancelar" onclick="FecharPopUp()">
                Cancelar
            </button>
            <button class="btn-confirmar" onclick="FinalizarCompra('@UserManager.GetUserName(User)', @pedido?.IdPedido)">
                CONFIRMAR <i class="fas fa-check ms-2"></i>
            </button>
        </div>
    </div>
</div>

<div id="LoadingOverlay">
    <div class="loading-content">
        <div class="reactor-loader">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="icon-center">
                <i class="fas fa-hamburger icon-burger"></i>
                <i class="fas fa-shopping-cart icon-cart"></i>
            </div>
        </div>
        <h3 class="loading-text">ATUALIZANDO...</h3>
    </div>
</div>

<script>
    window.ofertasAtivasGlobais = @Json.Serialize(ofertasAtivas.Select(o => new { idHamburguer = o.idHamburguer, porcentagem = o.porcentagem }));

    function FecharPopUp() {
        document.getElementById("PopUpNaoTemCEP").classList.remove("Aparecer");
    }

</script>
