@model IEnumerable<TecBurguer.Models.Hamburguer>

@{
    ViewData["Title"] = "Index";

    bool existemItensSemEstoque = Model.Any(item =>
        !item.HamburguerIgredientes.Any() ||
        !item.HamburguerIgredientes.All(i => i.IdIngredienteNavigation!.Quantidade >= i.QuantidadeNecessario)
    );
}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ranchers&family=Poppins:wght@300;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="~/css/Hamburgueres.css" rel="stylesheet" />
<div class="page-header">
    <h1 class="page-title">GERENCIAR HAMBÚRGUERES</h1>
    <p class="page-subtitle">Adicione, edite ou remova itens do cardápio</p>
</div>

<div class="burger-grid">

    <a asp-action="Create" class="burger-card create-card">
        <div class="create-icon">+</div>
        <div class="create-text">NOVO ITEM</div>
    </a>

    @foreach (var item in Model)
    {
        bool temEstoque = item.HamburguerIgredientes.Any() &&
        item.HamburguerIgredientes.All(i => i.IdIngredienteNavigation!.Quantidade >= i.QuantidadeNecessario);

        <div class="burger-card">

            @if (temEstoque)
            {
                <a asp-controller="Ofertas" asp-action="Create" asp-route-hamburguerId="@item.IdHamburguer" class="btn-offer-float">
                    <i class="fas fa-tag"></i> Oferta
                </a>
            }
            else
            {
                <div class="out-of-stock-badge">ESGOTADO</div>
            }

            <img src="@Html.DisplayFor(modelItem => item.Imagem)"
                 class="card-img-top @(temEstoque ? "" : "grayscale")"
                 alt="@item.Nome"
                 onerror="this.src='/css/Imagens/BurguerLogo.png'">

            <div class="card-body">
                <h3 class="card-title">@item.Nome</h3>

                <p class="card-text">@item.Descricao</p>

                <div class="card-price">R$ @item.Preco</div>

                <div class="action-buttons">
                    <a asp-action="Details" asp-route-id="@item.IdHamburguer" class="btn-action btn-details">
                        Detalhes
                    </a>
                    <a asp-action="Edit" asp-route-id="@item.IdHamburguer" class="btn-action btn-edit" title="Editar">
                        <i class="fas fa-pen"></i>
                    </a>
                    <a asp-action="Delete" asp-route-id="@item.IdHamburguer" class="btn-action btn-delete" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<div id="StockWarningModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>

        <h2 class="modal-title" id="modalTitle">ITEM INDISPONÍVEL!</h2>

        <div class="modal-text" id="modalBody">
            <p>
                O item <strong id="modalItemName" style="color: white;"></strong> não pode ser vendido no momento.
                <br><br>
                <strong>Motivos prováveis:</strong>
                <br>❌ <strong>Receita Incompleta:</strong> Nenhum ingrediente vinculado.
                <br>❌ <strong>Estoque Baixo:</strong> Ingredientes insuficientes.
            </p>
        </div>

        <div class="modal-buttons">
            <a asp-controller="HamburguerIgredientes" asp-action="Index" class="btn-modal btn-recipe">
                <i class="fas fa-list-ul"></i> Configurar Receita
            </a>
            <a asp-controller="Ingredientes" asp-action="Index" class="btn-modal btn-stock">
                <i class="fas fa-cubes"></i> Repor Estoque
            </a>
        </div>

        <button class="btn-close-modal" onclick="closeStockModal()">Fechar aviso</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const existemItensSemEstoque = @existemItensSemEstoque.ToString().ToLower();

        if (existemItensSemEstoque) {
            openGeneralStockModal();
        }
    });

    function openGeneralStockModal() {
        document.getElementById('modalTitle').innerText = "ATENÇÃO AO ESTOQUE!";

        document.getElementById('modalBody').innerHTML = `
            <p>
                Detectamos que <strong>existem itens esgotados</strong> no seu cardápio.
                <br><br>
                Isso impede que os clientes comprem esses lanches. Verifique se os ingredientes estão cadastrados e se há quantidade suficiente no estoque.
            </p>
        `;

        document.getElementById('StockWarningModal').style.display = 'flex';
    }

    function openStockModal(nomeItem) {
        document.getElementById('modalTitle').innerText = "ITEM INDISPONÍVEL!";

        document.getElementById('modalBody').innerHTML = `
            <p>
                O item <strong style="color: white;">${nomeItem}</strong> não pode ser vendido no momento.
                <br><br>
                <strong>Motivos prováveis:</strong>
                <br>❌ <strong>Receita Incompleta:</strong> Nenhum ingrediente vinculado.
                <br>❌ <strong>Estoque Baixo:</strong> Ingredientes insuficientes.
            </p>
        `;

        document.getElementById('StockWarningModal').style.display = 'flex';
    }

    function closeStockModal() {
        document.getElementById('StockWarningModal').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('StockWarningModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>